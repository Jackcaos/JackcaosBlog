<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>从JS的运行机制谈到EventLoop | Jackcaos’s Blog</title>
    <meta name="generator" content="VuePress 1.8.0">
    <link rel="icon" href="/JackcaosBlog/favicon.ico">
    <meta name="description" content="Do one thing at a time, and do well">
    
    <link rel="preload" href="/JackcaosBlog/assets/css/0.styles.f66641df.css" as="style"><link rel="preload" href="/JackcaosBlog/assets/js/app.6a641a8a.js" as="script"><link rel="preload" href="/JackcaosBlog/assets/js/2.b30e03fa.js" as="script"><link rel="preload" href="/JackcaosBlog/assets/js/8.97e58282.js" as="script"><link rel="prefetch" href="/JackcaosBlog/assets/js/10.21ed4734.js"><link rel="prefetch" href="/JackcaosBlog/assets/js/11.ee528930.js"><link rel="prefetch" href="/JackcaosBlog/assets/js/12.34040ee7.js"><link rel="prefetch" href="/JackcaosBlog/assets/js/13.a8a72935.js"><link rel="prefetch" href="/JackcaosBlog/assets/js/14.960b4da5.js"><link rel="prefetch" href="/JackcaosBlog/assets/js/3.0c333323.js"><link rel="prefetch" href="/JackcaosBlog/assets/js/4.ddf9e834.js"><link rel="prefetch" href="/JackcaosBlog/assets/js/5.e6107653.js"><link rel="prefetch" href="/JackcaosBlog/assets/js/6.7abbc901.js"><link rel="prefetch" href="/JackcaosBlog/assets/js/7.a404c475.js"><link rel="prefetch" href="/JackcaosBlog/assets/js/9.6054b180.js">
    <link rel="stylesheet" href="/JackcaosBlog/assets/css/0.styles.f66641df.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/JackcaosBlog/" class="home-link router-link-active"><!----> <span class="site-name">Jackcaos’s Blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/JackcaosBlog/web-front/functional.html" class="nav-link">
  前端基础
</a></div><div class="nav-item"><a href="/JackcaosBlog/react/tsreact.html" class="nav-link">
  React
</a></div><div class="nav-item"><a href="/JackcaosBlog/engineering/babelrc.html" class="nav-link">
  工程化
</a></div><div class="nav-item"><a href="/JackcaosBlog/node.html" class="nav-link">
  Node
</a></div><div class="nav-item"><a href="/JackcaosBlog/algorithm.html" class="nav-link">
  算法
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="GitHub" class="dropdown-title"><span class="title">GitHub</span> <span class="arrow down"></span></button> <button type="button" aria-label="GitHub" class="mobile-dropdown-title"><span class="title">GitHub</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/Jackcaos" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub地址
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/JackcaosBlog/web-front/functional.html" class="nav-link">
  前端基础
</a></div><div class="nav-item"><a href="/JackcaosBlog/react/tsreact.html" class="nav-link">
  React
</a></div><div class="nav-item"><a href="/JackcaosBlog/engineering/babelrc.html" class="nav-link">
  工程化
</a></div><div class="nav-item"><a href="/JackcaosBlog/node.html" class="nav-link">
  Node
</a></div><div class="nav-item"><a href="/JackcaosBlog/algorithm.html" class="nav-link">
  算法
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="GitHub" class="dropdown-title"><span class="title">GitHub</span> <span class="arrow down"></span></button> <button type="button" aria-label="GitHub" class="mobile-dropdown-title"><span class="title">GitHub</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/Jackcaos" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub地址
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>函数式编程</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/JackcaosBlog/web-front/functional.html" class="sidebar-link">函数柯里化与函数组合</a></li></ul></section></li><li><a href="/JackcaosBlog/web-front/lighthouse.html" class="sidebar-link">lighthouse性能分析</a></li><li><a href="/JackcaosBlog/web-front/eventloop.html" aria-current="page" class="active sidebar-link">从JS的运行机制谈到EventLoop</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/JackcaosBlog/web-front/eventloop.html#前言" class="sidebar-link">前言</a></li><li class="sidebar-sub-header"><a href="/JackcaosBlog/web-front/eventloop.html#单线程的js" class="sidebar-link">单线程的JS</a></li><li class="sidebar-sub-header"><a href="/JackcaosBlog/web-front/eventloop.html#解决单线程的问题" class="sidebar-link">解决单线程的问题</a></li><li class="sidebar-sub-header"><a href="/JackcaosBlog/web-front/eventloop.html#eventloop" class="sidebar-link">EventLoop</a></li><li class="sidebar-sub-header"><a href="/JackcaosBlog/web-front/eventloop.html#eventloop练习题" class="sidebar-link">EventLoop练习题</a></li><li class="sidebar-sub-header"><a href="/JackcaosBlog/web-front/eventloop.html#结语" class="sidebar-link">结语</a></li></ul></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="前言"><a href="#前言" class="header-anchor">#</a> 前言</h2> <p>我第一次接触到<code>EventLoop</code>的这个词的时候，还是在2年前的准备的实习面试，当时去应聘的第一家公司，面试官写了一大串<code>setTimeout</code>,<code>Promise</code>,<code>console.log</code>的代码来问我执行顺序，我当时人都是懵的，那时候的我还是只会用一堆<code>API</code>的小白，那次面试之后，我去网上看到了很多<code>EventLoop</code>的面试题，然后我就像是去背公式那样记下来<code>setTimeout</code>最后执行,<code>Promise</code>和<code>console.log</code>先执行，但是自己其实连<code>EventLoop</code>怎么来的都不知道，所以这样导致面试的时候有些问题稍微深挖一下就不知道，或者说自己在工作中真的遇到了这种问题也无从下手，<code>知其然也要知其所以然</code>，对此两年后的今天再详细的谈谈<code>EventLoop</code>是怎样的一个东西。</p> <p>本文不会上来就丢出<code>EventLoop</code>的概念和题目！！！这样很没意思，文章不长慢慢看下去。</p> <h2 id="单线程的js"><a href="#单线程的js" class="header-anchor">#</a> 单线程的JS</h2> <p>大学期间大家基本都学习过<code>Java</code>，<code>Java</code>作为一门<code>多线程</code>的语言，<code>一个进程其可以创建多个不同的线程来执行不同的任务</code>，多个线程的好处大家基本都知道，当一个线程等待时其他的线程并不会跟着等待，就相当于高速公路有多个车道，并不会因为一台车故障了，所有的车全部动不了，这样的话也更好的<code>提高了CPU的利用率</code>。</p> <p>这么一听好像挺不错的，那为啥我们的<code>JavaScript</code>确实单线程为啥不是多线程呢？难道就不怕我们的<code>JavaScript</code>代码执行的时候发生阻塞吗？</p> <p>回答这个问题又要回到我们经典的DOM问题，如果JS是多线程，那一个线程需要操作一个DOM节点，而另一个线程要删除这个DOM节点那么该执行那个线程的任务呢？为了不让问题变得复杂，JavaScript从一开始就是单线程的。</p> <p>当然后续HTML5的新特性中有web worker这个新特性允许JavaScript创建更多的线程，但是这些线程是<code>严格受到主线程的控制</code>并且<code>无法操作DOM元素</code>。</p> <h2 id="解决单线程的问题"><a href="#解决单线程的问题" class="header-anchor">#</a> 解决单线程的问题</h2> <p>既然JavaScript是单线程的，让人不禁的想到那是不是<code>很容易发生阻塞</code>？那处理耗时的任务（如Ajax请求和文件读写）岂不是会导致程序阻塞很长时间？那JS是怎么处理的呢？</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 伪代码</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span>
<span class="token function">ajax</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>如果上面的代码全是同步执行的，那么必定需要等待ajax()执行完毕才能打印c变量，但是c变量完全和ajax()完全无关,让ajax()占用我们的主线程属实有点浪费资源。为此<code>JavaScript的设计者</code>也意识到这个问题，那遇到这种费时的操作可以先挂起此任务，让后面的任务继续执行。为此JavaScript分为了<code>同步任务和异步任务</code>。</p> <p><code>同步任务</code>：同步任务很好理解，就是主线程按代码顺序执行，前一个任务执行完才执行下一个任务执行。</p> <p><code>异步任务</code>：异步任务则是不是在主线程中执行，而是当异步任务执行完毕之后会放一个回调函数到任务队列中去，待主线程执行完毕，主线程才会读取任务队列的任务开始执行。</p> <p>主线程中的任务执行流程图可归纳为下：</p> <p><img src="/JackcaosBlog/assets/img/eventloop1.8462c6a9.jpg" alt="image.png"></p> <p>既然了解了同步任务和异步任务的执行顺序，接下来我们下面的程序怎么运行：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>先执行同步任务<code>1-&gt;4</code>，异步任务加入<code>任务队列（先进先出）</code>中可得<code>2-&gt;3</code>，组合可得答案为<code>1-&gt;4-&gt;2-&gt;3</code></p> <p>当然现在基本面试题不可能考的这么简单，比如下面这题：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
<span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
    <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>如果按上面规则来说我们得出的答案是<code>1-&gt;5-&gt;3-&gt;2-&gt;4</code>，但是运行发现我们的答案明显是错的，为此我们需要明确异步任务中的一个定义就是宏任务和微任务。</p> <h2 id="eventloop"><a href="#eventloop" class="header-anchor">#</a> EventLoop</h2> <p>什么是宏任务，什么是微任务呢？</p> <p><code>宏任务</code>：宏任务包括 script ， setTimeout ，setInterval ，<code>setImmediate（Node中才有）</code>，I/O ，UI rendering。</p> <p><code>微任务</code>：微任务包括 <code>process.nextTick（Node中才有）</code>，promise ，MutationObserver。</p> <p>所以说我们的异步任务还细分为了宏任务和微任务，那他们的执行顺序是怎样的呢？</p> <p>1）当主线程中的同步任务执行完之后，主线程会查看异步任务中微任务队列中是否有可执行的任务，同理一样是先进先执行（队列的执行顺序）。</p> <p>2）微任务队列中的任务执行完毕后，主线程会检查宏任务队列中是否有可执行的任务，任务执行顺序同样是先进先执行。</p> <p>3)执行完微任务和宏任务后表示本轮异步任务执行完毕。
上述的异步任务执行的过程会不断的循环♻️，这也就是我们总是说的<code>EventLoop(事件循环)</code>。</p> <p>那么我们再看看我们做错的那道题：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
<span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
    <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>现在来看是不是直接可以得出结果是<code>1-&gt;3-&gt;5-&gt;4-&gt;2</code>。</p> <h2 id="eventloop练习题"><a href="#eventloop练习题" class="header-anchor">#</a> EventLoop练习题</h2> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 练习1</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>

<span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token parameter">resolve</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
  <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>先分析一下，同步任务有<code>1,3,6</code>，则同步任务按顺序一个一个执行可得<code>1-&gt;3-&gt;6</code>，而微任务有<code>4，5</code>，按顺序放入微任务队列<code>4-&gt;5</code>，宏任务只有<code>2</code>放入宏任务队列，最终我们按照同步任务-&gt;微任务-&gt;宏任务的顺序可得答案为<code>1-&gt;3-&gt;6-&gt;4-&gt;5-&gt;2</code>。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 练习2</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>这题和上面分析步骤一样，答案为<code>1-&gt;6-&gt;7-&gt;2-&gt;3-&gt;4-&gt;5</code></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 练习3</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">async1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">await</span> <span class="token function">async2</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">async2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token function">async1</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>

<span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br></div></div><p>答案是<code>1-&gt;3-&gt;6-&gt;2-&gt;7-&gt;8-&gt;4-&gt;5</code>，这题不知道你有没有点懵，这两个async的函数属实有点捣乱，那我们来理解一下async这一步转换一下：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
    <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>这样的话<code>2</code>就被添加到了微任务的队列，而<code>2</code>由于先于<code>4,5,7,8</code>进入微任务队列所以先执行,而<code>4,5</code>属于宏任务里面执行的微任务，则最后才被添加到微任务队列中,所以微任务的顺序为<code>2-&gt;7-&gt;8-&gt;4-&gt;5</code>，同步任务的顺序为<code>1-&gt;3-&gt;6</code>，得最后答案<code>1-&gt;3-&gt;6-&gt;2-&gt;7-&gt;8-&gt;4-&gt;5</code>。</p> <h2 id="结语"><a href="#结语" class="header-anchor">#</a> 结语</h2> <p>其实只要理解了JS和EventLoop的任务运行机制，解EventLoop的题目基本就是<code>万变不离其宗</code>。</p> <p>参考：</p> <p><a href="http://www.ruanyifeng.com/blog/2014/10/event-loop.html" target="_blank" rel="noopener noreferrer">JavaScript 运行机制详解：再谈Event Loop<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><a href="https://juejin.cn/book/6844733763675488269/section/6844733763763568654" target="_blank" rel="noopener noreferrer">yck:前端面试之道<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">5/23/2021, 4:56:53 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/JackcaosBlog/web-front/lighthouse.html" class="prev">
        lighthouse性能分析
      </a></span> <!----></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/JackcaosBlog/assets/js/app.6a641a8a.js" defer></script><script src="/JackcaosBlog/assets/js/2.b30e03fa.js" defer></script><script src="/JackcaosBlog/assets/js/8.97e58282.js" defer></script>
  </body>
</html>
